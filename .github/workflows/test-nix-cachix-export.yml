name: Uses nix-store export

on: [push]

jobs:
  nix-cachix-export:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: nix-shell --run "/usr/bin/bash --noprofile --norc -e -o pipefail {0}"

    steps:
      - uses: actions/checkout@v3
      - name: Create cache dir
        run: sudo mkdir -p /nixcache && sudo chown -R $USER /nixcache
        shell: bash
      - name: Load cache
        id: cache-nix-export
        uses: actions/cache@v3
        with:
          path: /nixcache/cache.nixstore
          key: funkeyd4
      - name: Install nix
        uses: cachix/install-nix-action@v17
        with:
          nix_path: nixpkgs=channel:nixos-22.05
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      - name: Restore cache
        run: sudo $(which nix-store) --import < /nixcache/cache.nixstore
        if: steps.cache-nix-export.outputs.cache-hit == 'true'
        shell: bash
      - name: Setup postrun C
        uses: webiny/action-post-run@2.0.1
        id: prepare-cache-c
        with:
          run:
            bash -c "sudo rm -rf /nixcache/cache.nixstore ; nix-store --export $(nix path-info --all) >
            /nixcache/cache.nixstore"

      - run: pnpm install
      - run: pnpm test
