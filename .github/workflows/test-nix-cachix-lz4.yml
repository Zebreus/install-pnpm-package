name: Uses tarball with lz4

on: [push]

jobs:
  nix-cachix-lz4:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: nix-shell --run "/usr/bin/bash --noprofile --norc -e -o pipefail {0}"

    steps:
      - uses: actions/checkout@v3
      - name: Create cache dir
        run: sudo mkdir -p /nixcache && sudo chown -R $USER /nixcache
        shell: bash
      - name: Load cache
        id: cache-nix-copy
        uses: actions/cache@v3
        with:
          path: /nixcache
          key: funkeyf6
      - name: Install nix
        uses: cachix/install-nix-action@v17
        with:
          nix_path: nixpkgs=channel:nixos-22.05
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      - name: Restore cache
        run: |-
          sudo tar --same-owner -I /nixcache/lz4 --directory / -xf /nixcache/store.tar.lz4
          sudo $(which nix-store) --load-db < /nixcache/nix.db
        if: steps.cache-nix-copy.outputs.cache-hit == 'true'
        shell: bash
      - name: Setup postrun command to create cache
        uses: webiny/action-post-run@2.0.1
        id: prepare-cache
        with:
          run:
            bash -c "sudo rm -rf /nixcache/store.tar.lz4 ; nix-store --dump-db > /nixcache/nix.db ; sudo apt update
            --yes ; sudo apt install lz4 --yes ; sudo cp -raf $(which lz4) /nixcache ; sudo tar -I /nixcache/lz4 -cf
            /nixcache/store.tar.lz4 /nix/store"

      - run: pnpm install
      - run: pnpm test
